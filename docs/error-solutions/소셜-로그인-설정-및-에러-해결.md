# 소셜 로그인 설정 가이드 & 에러 해결

> Surf Wave 앱의 Google/Kakao 소셜 로그인 연동 과정에서 발생한 에러와 해결 방법 정리

---

## 목차
1. [카카오 로그인 설정](#1-카카오-로그인-설정)
2. [카카오 에러 모음](#2-카카오-에러-모음)
3. [구글 로그인 설정](#3-구글-로그인-설정)
4. [구글 에러 모음](#4-구글-에러-모음)
5. [백엔드 공통 에러](#5-백엔드-공통-에러)

---

## 1. 카카오 로그인 설정

### 1-1. Kakao Developers 콘솔 기본 설정

1. https://developers.kakao.com 접속 → 로그인
2. **내 애플리케이션** → **애플리케이션 추가하기**
3. 앱 생성 후 **앱 키** 확인:
   - **JavaScript 키** → 프론트엔드 `VITE_KAKAO_JS_KEY`에 사용
   - **REST API 키** → 백엔드 `KAKAO_REST_API_KEY`에 사용

### 1-2. 플랫폼 등록 + Redirect URI 등록 (핵심!)

> **이 과정을 빠뜨리면 "redirect_uri is not registered" 에러 발생**

1. **앱** 선택 → **플랫폼키** 섹션에서 **JavaScript 키** 옆 `...` (점 3개 메뉴) 클릭
2. **수정** 클릭
3. **JavaScript SDK 도메인 설정**에 추가:
   ```
   http://localhost:5173
   ```
4. **카카오 로그인 리다이렉트 URI 설정**에 추가:
   ```
   http://localhost:5173/auth/kakao/callback
   ```
5. 저장

**주의**: URI가 정확히 일치해야 함. 끝에 `/` 하나만 달라도 에러 발생.

### 1-3. 동의항목 설정

1. **제품 설정** → **카카오 로그인** → **동의항목**
2. 최소 필수 항목:
   - **닉네임**: 필수 동의
   - **이메일**: 선택 동의 (비즈앱 전환 전에는 "필수 동의" 불가)
3. **이메일 미제공 대응**: 백엔드에서 이메일 없을 시 `kakao_{id}@kakao.user` 형태로 자동 생성 처리됨

### 1-4. 환경변수 설정

**프론트엔드** (`surf-wave-frontend/.env`):
```env
VITE_KAKAO_JS_KEY=a06742c8e6023686a522dd875bc9f1ad
VITE_KAKAO_REST_API_KEY=b70df9f595f363cd8fbfb637d1e19ca9
```

**백엔드** (`surf-wave-backend/.env`):
```env
KAKAO_REST_API_KEY=b70df9f595f363cd8fbfb637d1e19ca9
```

---

## 2. 카카오 에러 모음

### 에러: `KOE006 - redirect_uri is not registered`

**증상**: 카카오 로그인 버튼 클릭 후 카카오 페이지에서 에러 표시

**원인**: Redirect URI가 등록되지 않음

**해결**:
1. 앱 → 플랫폼키 → JavaScript 키 옆 `...` → 수정
2. **카카오 로그인 리다이렉트 URI 설정**에 추가:
   ```
   http://localhost:5173/auth/kakao/callback
   ```
3. 프론트엔드 코드의 redirectUri와 콘솔 등록값이 **완전히 동일**한지 확인:
   ```typescript
   // Login.tsx
   Kakao.Auth.authorize({
     redirectUri: `${window.location.origin}/auth/kakao/callback`,
   });
   // → http://localhost:5173/auth/kakao/callback
   ```

---

### 에러: `401 Unauthorized` (카카오 토큰 교환 실패)

**증상**: 카카오 로그인 후 리다이렉트는 되는데 백엔드에서 401 반환

**원인 1**: 백엔드 `.env`에 `KAKAO_REST_API_KEY`가 없거나, `.env` 수정 후 서버를 재시작하지 않음

**해결**:
```bash
# 1. .env 파일에 키가 있는지 확인
cat surf-wave-backend/.env | grep KAKAO

# 2. 백엔드 서버 재시작 (환경변수 다시 로드)
cd surf-wave-backend && npm run start:dev
```

**원인 2**: 인가코드(code)가 이미 사용됨 (카카오 인가코드는 일회용)

**해결**: 브라우저에서 다시 카카오 로그인 시도 (새로운 인가코드 발급)

---

### 에러: `허용되지 않는 도메인` 또는 SDK 초기화 실패

**증상**: Kakao.Auth.authorize() 호출 시 에러

**원인**: JavaScript SDK 도메인에 현재 사이트 주소 미등록

**해결**:
1. 앱 → 플랫폼키 → JavaScript 키 옆 `...` → 수정
2. **JavaScript SDK 도메인 설정**에 `http://localhost:5173` 추가

---

### 에러: `카카오 계정에 이메일이 없습니다`

**증상**: 카카오 로그인 자체는 성공하지만 이메일 관련 에러

**현재 처리 방식**: 이 에러는 더 이상 발생하지 않음. 이메일 미제공 시 `kakao_{id}@kakao.user` 형태로 자동 생성됨 (auth.service.ts 298행)

---

## 3. 구글 로그인 설정

### 3-1. Google Cloud Console 기본 설정

1. https://console.cloud.google.com 접속
2. 프로젝트 선택 (또는 새 프로젝트 생성)
3. **API 및 서비스** → **사용자 인증 정보**
4. **사용자 인증 정보 만들기** → **OAuth 클라이언트 ID**
5. 애플리케이션 유형: **웹 애플리케이션**

### 3-2. 승인된 출처 & 리다이렉션 URI 설정 (필수!)

> 이걸 안 하면 "origin is not allowed" 에러 발생

**승인된 JavaScript 원본** (Authorized JavaScript origins):
```
http://localhost:5173
http://localhost
```

**승인된 리다이렉션 URI** (Authorized redirect URIs):
```
http://localhost:5173
```

저장 후 **클라이언트 ID** 복사 → 프론트엔드 환경변수에 설정

### 3-3. OAuth 동의 화면 설정

1. **API 및 서비스** → **OAuth 동의 화면**
2. **User Type**: 외부 (테스트 중에는 테스트 사용자 추가 필요)
3. 필수 범위 추가:
   - `email`
   - `profile`
   - `openid`
4. **테스트 사용자** 탭에서 테스트용 Gmail 계정 추가

### 3-4. 환경변수 설정

**프론트엔드** (`surf-wave-frontend/.env`):
```env
VITE_GOOGLE_CLIENT_ID=1070042796453-of66enkoc3i23irnug81atp56gpugkv1.apps.googleusercontent.com
```

**백엔드**: 별도 환경변수 불필요 (프론트에서 받은 ID 토큰을 Google tokeninfo API로 직접 검증)

---

## 4. 구글 에러 모음

### 에러: `[GSI] The given origin is not allowed for the given client ID`

**증상**: 브라우저 콘솔에 위 에러. Google 로그인 팝업이 안 뜨거나 즉시 닫힘.

**원인**: Google Cloud Console에서 `http://localhost:5173`을 승인된 JavaScript 원본에 등록하지 않음

**해결**:
1. Google Cloud Console → **API 및 서비스** → **사용자 인증 정보**
2. 해당 OAuth 2.0 클라이언트 ID 클릭
3. **승인된 JavaScript 원본**에 추가:
   ```
   http://localhost:5173
   http://localhost
   ```
4. **저장** 클릭
5. **반영까지 5분~30분 소요될 수 있음** (캐시 때문)

---

### 에러: `Google 로그인을 초기화하는 중입니다`

**증상**: Google 로그인 버튼 클릭 시 이 메시지 표시

**원인**: Google GIS SDK가 아직 로드되지 않았거나, `VITE_GOOGLE_CLIENT_ID`가 설정 안 됨

**해결**:
1. `.env` 파일에 `VITE_GOOGLE_CLIENT_ID` 확인
2. `index.html`에 Google GIS 스크립트가 있는지 확인:
   ```html
   <script src="https://accounts.google.com/gsi/client" async defer></script>
   ```
3. 브라우저 새로고침 (스크립트 로드 대기)

---

### 에러: `popup_closed_by_user`

**증상**: Google 로그인 팝업이 뜨지만 바로 닫힘

**원인**: 쿠키 차단 또는 서드파티 쿠키 비활성화

**해결**:
- Chrome 시크릿 모드에서는 서드파티 쿠키 차단이 기본 → 일반 모드에서 시도
- Chrome 설정 → 개인정보 및 보안 → 서드파티 쿠키 → 허용

---

## 5. 백엔드 공통 에러

### 에러: 포트 3000 충돌 (`EADDRINUSE`)

**증상**: 백엔드 시작 시 `Error: listen EADDRINUSE: address already in use :::3000`

**원인**: 이전 node 프로세스가 아직 살아 있음

**해결** (Windows):
```bash
# 1. 포트 3000 사용 중인 프로세스 PID 확인
netstat -ano | findstr :3000 | findstr LISTENING

# 2. 해당 PID 강제 종료
cmd /c "taskkill /F /PID {PID번호}"

# 또는 모든 node 프로세스 종료
cmd /c "taskkill /F /IM node.exe"

# 3. 백엔드 재시작
cd surf-wave-backend && npm run start:dev
```

---

### 에러: `.env` 수정 후 반영이 안 됨

**증상**: `.env`에 키를 추가했는데 백엔드에서 `undefined`로 읽힘

**원인**: NestJS의 ConfigService는 서버 시작 시점에 `.env`를 한 번만 읽음. 수정 후 서버 재시작 필수.

**해결**: 백엔드 서버 종료 후 재시작
```bash
# 실행 중인 서버 종료 (Ctrl+C) 후
cd surf-wave-backend && npm run start:dev
```

---

## 소셜 로그인 전체 흐름 요약

### 카카오 로그인 흐름
```
[프론트] 카카오 로그인 버튼 클릭
    ↓
[프론트] Kakao.Auth.authorize({ redirectUri }) 호출
    ↓
[카카오] 카카오 로그인 페이지 표시 → 사용자 로그인/동의
    ↓
[카카오] redirectUri로 리다이렉트 (?code=인가코드)
    ↓
[프론트] App.tsx에서 URL의 code 파라미터 감지
    ↓
[프론트] POST /api/v1/auth/kakao/callback { code, redirectUri }
    ↓
[백엔드] 인가코드 → Kakao token API로 액세스 토큰 교환
    ↓
[백엔드] 액세스 토큰 → Kakao user/me API로 사용자 정보 조회
    ↓
[백엔드] DB에 사용자 생성/조회 → JWT 발급 → 응답
    ↓
[프론트] JWT 저장 → 메인 화면 이동
```

### 구글 로그인 흐름
```
[프론트] 구글 로그인 버튼 클릭
    ↓
[프론트] Google GIS SDK가 팝업 표시 → 사용자 로그인
    ↓
[Google] credential(ID 토큰)을 콜백으로 전달
    ↓
[프론트] POST /api/v1/auth/google { credential }
    ↓
[백엔드] ID 토큰 → Google tokeninfo API로 검증
    ↓
[백엔드] DB에 사용자 생성/조회 → JWT 발급 → 응답
    ↓
[프론트] JWT 저장 → 메인 화면 이동
```

---

## 체크리스트 (문제 발생 시 확인)

- [ ] Kakao: 앱 → 플랫폼키 → JS키 `...` → 수정 → SDK 도메인에 `http://localhost:5173` 등록?
- [ ] Kakao: 같은 곳에서 리다이렉트 URI에 `http://localhost:5173/auth/kakao/callback` 등록?
- [ ] Kakao: 동의항목에 닉네임/이메일 설정?
- [ ] Google: 승인된 JavaScript 원본에 `http://localhost:5173` 등록?
- [ ] Google: 승인된 리다이렉션 URI에 `http://localhost:5173` 등록?
- [ ] Google: OAuth 동의 화면에 테스트 사용자 추가?
- [ ] 프론트엔드 `.env`에 `VITE_GOOGLE_CLIENT_ID`, `VITE_KAKAO_JS_KEY` 설정?
- [ ] 백엔드 `.env`에 `KAKAO_REST_API_KEY` 설정?
- [ ] `.env` 수정 후 서버 재시작?
