# 파도 계산 시 거짓음성(False Negative) 오류 해결

> **작성일**: 2026-02-17
> **해결 버전**: surf-rating v1.4.1 → v1.4.2
> **관련 파일**: `surf-wave-backend/src/modules/forecasts/utils/surf-rating.util.ts`
> **테스트 파일**: `surf-wave-backend/src/modules/forecasts/utils/surf-rating.util.spec.ts`
> **검증 파일**: `surf-wave-backend/src/modules/forecasts/utils/surf-rating-v142-verify.spec.ts`

---

## 1. 문제점

### 1-1. "거짓음성"이란?

```
거짓음성 = 앱이 "BLOCKED(위험)" 또는 "매우 낮은 점수"로 판정했지만,
           실제로는 서핑 가능하거나 괜찮은 상황
```

병원 건강검진에 비유하면:
- 혈압 131/91 (기준 130/90 바로 위) → "고혈압" 판정
- 하지만 혈당·콜레스테롤·체중 전부 완벽

→ 수치 하나가 기준을 1만 초과해도 "건강 위험"이라고 하면 과잉 진단.
→ **다른 조건이 전부 좋으면** 의사는 "경과 관찰" 정도로 판단함.

우리 서핑 앱도 **동일한 과잉 차단 문제**가 있었음.

> **중요**: 거짓양성(v1.4.1)은 안전 문제였지만, 거짓음성은 **UX/정확도 문제**.
> 따라서 **안전을 해치지 않는 범위 내에서만** 보정함.

---

### 1-2. 기존 v1.4.1 엔진 구조의 한계

```
[STEP 1] 하드블록 안전 필터
  → 파고 > 1.2m + 초보 → BLOCKED (무조건 차단, 예외 없음)

[STEP 2] 5개 항목 점수 계산
  → waveFit: tolerable 범위 밖이면 무조건 0점 (1cm 차이도 0점)
  → windDirFit: 온쇼어면 무조건 1점 (바람이 0이라도 1점)

[STEP 3] 가중 합산 → surfRating
  → waveFit=0이면 waveMultiplier=0.2 → 최종 ~2점

[STEP 3.5] 거짓양성 보정
[STEP 4] 추천 메시지
```

**핵심 문제 3가지**:
- 하드블록은 **칼같은 임계값 ON/OFF** → 경계 바로 위에서 무조건 차단
- waveFit은 **tolerable 밖이면 무조건 0점** → 측정 오차(±5cm) 무시
- windDirFit은 **풍속 무관하게 방향만 보고 감점** → 글래시에서도 온쇼어 페널티

---

### 1-3. 발견된 거짓음성 4건 (→ 3건 실제 문제)

| # | 시나리오 | 현재 동작 | 실제 | 판정 |
|---|---------|----------|------|------|
| FN-1 | 파고 1.25m + beach_break + 나머지 완벽 | BLOCKED | 주의하면 서핑 가능 | **보정 필요** |
| FN-2 | 온쇼어인데 풍속 3km/h (글래시) | windDirFit=1 → 점수 크게 깎임 | 풍향 무의미 | **보정 필요** |
| FN-3 | 수온 13°C 이중 페널티 | 겹칠 수 있음? | 코드 확인 결과 겹치지 않음 | 보정 불필요 |
| FN-4 | 파고 0.28m (tolMin=0.3 바로 아래) | waveFit=0, 최종 2점 | 2cm 차이는 측정 오차 | **보정 필요** |

---

#### 거짓음성 FN-4: "파고 0.28m → 서핑 불가 판정" (측정 오차)

| 항목 | 실제 값 | 기준 | 기존 판정 | 실제 상황 |
|------|---------|:----:|:--------:|----------|
| 파고 | 0.28m | tolMin=0.30m | waveFit=0 (2cm 부족) | 측정 오차 범위 내 |
| 주기 | 10초 | — | periodFit=8 | 좋은 ground swell |
| 풍속 | 5km/h | — | windSpeedFit=8 | 약한 바람 |
| 풍향 | 오프쇼어 | — | windDirFit=10 | 최적 |

```
v1.4.1 판정:
  waveFit = 0 → waveMultiplier = 0.2 → 최종 약 2점
  메시지: "오늘은 쉬는 게 좋겠어요"

현실:
  파도가 0.28m든 0.30m든 서퍼는 차이를 못 느낌 (측정 오차 ±5cm)
  나머지 조건이 전부 좋으면 "파도는 약하지만 탈 만함"
```

**원인**: waveFit이 tolerable 경계에서 **칼같이 0점** → 2cm 차이로 전체 점수 붕괴.

---

#### 거짓음성 FN-2: "글래시인데 온쇼어 감점" (풍향 무의미)

| 항목 | 실제 값 | fit 점수 | 의미 |
|------|---------|:-------:|------|
| 풍속 | 3km/h | windSpeedFit = **10** | 글래시 (거울 같은 수면) |
| 풍향 | 온쇼어 | windDirFit = **1** | 기계적으로 "최악" 판정 |
| 파고 | 0.7m | waveFit = **10** | 초보 최적 범위 |
| 주기 | 10초 | periodFit = **8** | 좋은 ground swell |

```
v1.4.1 판정:
  가중합에서 windDirFit=1이 20% 가중치로 점수 하락
  최종 약 5~6점, 메시지: "무난한 컨디션이에요"

현실:
  바람이 3km/h면 수면이 거울처럼 잔잔함
  이 상태에서 "풍향"은 의미 없음 (어디서 불든 안 느낌)
  실제 점수는 8~9점이어야 함
```

**원인**: windDirFit이 **풍속과 무관하게** 각도만 보고 채점 → 글래시에서도 온쇼어 페널티.

---

#### 거짓음성 FN-1: "파고 1.25m → BLOCKED" (과잉 차단)

| 항목 | 실제 값 | 하드블록 기준 | 하드블록 판정 | 실제 상황 |
|------|---------|:----------:|:----------:|----------|
| 파고 | 1.25m | > 1.2m | **BLOCKED** (5cm 초과) | beach_break에서 서핑 가능 |
| 주기 | 12초 | — | — | 깨끗한 ground swell |
| 풍속 | 3km/h | — | — | 글래시 |
| 풍향 | 오프쇼어 | — | — | 파도면 깨끗 |
| 스팟 | beach_break | — | — | 모래바닥, 안전 |

```
v1.4.1 판정:
  STEP 1에서 파고 > 1.2m → BEGINNER BLOCKED
  추천 메시지: "파고 1.3m - 초보자에게 위험"

현실:
  beach_break(모래바닥)에서 1.25m는 주의하면 서핑 가능
  특히 나머지 조건(풍속, 주기, 방향)이 전부 완벽할 때
  reef_break에서 1.25m는 진짜 위험하지만, beach는 다름
```

**원인**: 하드블록이 **breakType 구분 없이** 1.2m 초과면 무조건 BLOCKED.

---

### 1-4. FN-3은 왜 보정 불필요?

```
초기 우려: 수온 13°C일 때 하드블록 WARNING + waveFit 감점이 이중 적용?

코드 확인 결과:
  - 하드블록: 수온 < 14°C → BEGINNER WARNING (levelFit 변경만)
  - waveFit: 수온과 무관 (파고만으로 계산)
  - compound risk: waterTemp 14~16°C 범위만 근접도 계산

→ 수온은 "levelFit 상태 변경"과 "compound risk 근접도"에서만 사용
→ waveFit 점수 자체에는 영향 없음 → 이중 페널티 없음
→ 보정 불필요
```

---

## 2. 고민한 방향

### 2-1. 거짓양성 vs 거짓음성 보정의 핵심 차이

```
거짓양성 보정 (v1.4.1):
  "위험한데 PASS" → 안전 문제 → 강하게 눌러야 함 → multiplier, cap 적용

거짓음성 보정 (v1.4.2):
  "괜찮은데 BLOCKED/낮은 점수" → UX 문제 → 조심스럽게 올려야 함
  ⚠️ 안전을 해치면 안 됨 → 보정 범위를 매우 좁게 제한
```

### 2-2. 검토한 접근법

| 보정 대상 | 접근법 | 설명 | 검토 결과 |
|-----------|--------|------|-----------|
| **FN-4 (waveFit 0점)** | A. tolerable 범위 확대 | 0.30→0.25로 변경 | ❌ 기존 테스트 깨짐, 다른 스팟에 영향 |
| | B. grace margin 추가 | 경계 ±5cm에서 1~2점 부여 | ✅ 기존 로직 무수정, 경계에서만 작동 |
| **FN-2 (windDirFit)** | A. 풍속을 windDirFit 공식에 통합 | 기존 채점 구조 변경 | ❌ 10개+ 기존 테스트 영향 |
| | B. 후처리 보정 | 채점 후 약풍이면 보정 | ✅ 기존 calcWindDirFit() 무수정 |
| **FN-1 (하드블록)** | A. 하드블록 임계값 상향 | 1.2→1.4m로 변경 | ❌ 안전 임계값 완화는 위험 |
| | B. 조건부 grace zone | 특정 조건에서만 완화 | ✅ 안전장치 충분, reef/point 제외 |

### 2-3. 보정 설계 원칙 (안전 우선)

```
1. "올리는" 보정이므로 최소 범위만 적용 (grace 5cm, grace zone 1.2~1.4m)
2. 최대 점수가 낮게 제한 (grace margin → 최대 2점, grace zone → WARNING만)
3. reef/point_break에서는 절대 완화 안 함
4. 보정 후에도 PASS가 아닌 WARNING 유지 (FN-1)
```

---

## 3. 왜 이 방식을 선택했는지

### 3-1. 전체 파이프라인 (v1.4.2)

```
기존 v1.4.1 엔진 (수정 없음)
  │
  ├─ [STEP 1]   하드블록 ────── 개별 위험 차단 (ON/OFF)
  ├─ [STEP 2]   5Fit 점수 ───── 각 항목 독립 채점
  │                               └─ calcWaveFit(): grace margin 추가 ← v1.4.2
  ├─ [STEP 2.5] ★ 약풍 풍향 보정 ← v1.4.2 (FN-2)
  │                applyLightWindDirCorrection()
  ├─ [STEP 3]   가중합 ─────── rawSurfRating 산출
  │
  ├─ [STEP 3.5] 거짓양성 보정 (기존 v1.4.1)
  │     ├─ ① 복합 위험 감점 (Compound Risk)
  │     └─ ② 품질 게이트 (Quality Gate)
  │
  ├─ [STEP 3.7] ★ 거짓음성 보정 ← v1.4.2 (FN-1)
  │     └─ ③ applyHardBlockGraceZone()
  │
  └─ [STEP 4]   추천 메시지 ─── 보정된 점수 기반
```

### 3-2. 각 보정의 위치를 선택한 이유

#### FN-4 (waveFit grace margin) → calcWaveFit() 내부

```
이유:
  waveFit은 STEP 2에서 계산 → 이후 STEP 3 가중합에 반영
  grace margin을 calcWaveFit() 내부에 넣으면
  가중합, waveMultiplier, compound risk 전부에 자연스럽게 반영됨

  ⚠️ 별도 후처리로 하면 waveMultiplier 계산에서 여전히 waveFit=0 사용
  → "waveFit grace" 효과가 불완전
```

#### FN-2 (약풍 windDirFit 보정) → STEP 2.5 (STEP 2 직후)

```
이유:
  windDirFit을 STEP 2 직후에 보정하면
  이후 STEP 3 가중합에서 보정된 windDirFit 사용
  + STEP 3.5 품질 게이트의 "windDirFit ≤ 2" 조건에도 반영

  글래시에서 windDirFit=7이 되면 품질 게이트 미발동 → 올바른 동작
  (글래시에서 온쇼어는 무의미하므로 게이트가 걸릴 이유 없음)
```

#### FN-1 (하드블록 grace zone) → STEP 3.7 (거짓양성 보정 이후)

```
이유:
  거짓양성 보정(3.5) 이후에 배치해야 하는 이유:
  1. 거짓양성 보정이 BEGINNER WARNING을 올릴 수 있음
  2. grace zone은 "BLOCKED → WARNING" 완화이므로 마지막에 적용
  3. 거짓양성 보정이 surfRating을 깎은 후에 grace zone 판단

  STEP 4(메시지) 전에 배치해야 하는 이유:
  1. 메시지가 보정된 levelFit/safetyReasons 기반으로 생성되어야 함
```

### 3-3. 안전장치 설계 (가장 중요)

```
FN-4 (grace margin):
  ✅ 최대 2점 → waveMultiplier = 0.73 → 최종 ~5.8점 (높은 점수 불가)
  ✅ 5cm 이내에서만 작동 → 0.20m 같은 완전 플랫은 여전히 0점

FN-2 (약풍 보정):
  ✅ effectiveWind < 5 (글래시)에서만 전체 보정 → 바람 5km/h 이상은 보정 약화
  ✅ effectiveWind ≥ 8이면 보정 없음 → 바람이 있으면 풍향이 의미 있으므로
  ✅ 품질 게이트 영향: 글래시일 때 windDirFit≥7 → 게이트 미발동 (올바름)

FN-1 (하드블록 grace zone):
  ✅ beach_break에서만 (reef/point 절대 완화 안 함)
  ✅ grace 상한 1.4m (1.41m부터 BLOCKED)
  ✅ 나머지 4개 fit 평균 ≥ 7.0 (매우 엄격)
  ✅ PASS가 아닌 WARNING으로만 완화 (여전히 주의 표시)
```

---

## 4. 해결 방법 상세

### 4-1. waveFit grace margin (FN-4): `calcWaveFit()` 수정

**위치**: `calcWaveFit()` 함수 내부

#### 기존 동작 vs 변경 후

```
기존 (v1.4.1):
  파고 < tolMin → waveFit = 0 (칼같은 경계)
  파고 > tolMax → waveFit = 0

변경 (v1.4.2):
  파고 < tolMin:
    tolMin-0.05 ~ tolMin 범위 → waveFit = 1~2 (grace zone)
    tolMin-0.05 미만            → waveFit = 0 (기존대로)

  파고 > tolMax:
    tolMax ~ tolMax+0.05 범위  → waveFit = 2~1 (grace zone)
    tolMax+0.05 초과            → waveFit = 0 (기존대로)
```

#### 점수 계산 상세

```
GRACE_MARGIN = 0.05 (5cm)

하한 grace zone (tolMin-0.05 ~ tolMin):
  graceRatio = (파고 - (tolMin - 0.05)) / 0.05
  waveFit = 1 + graceRatio  →  1점(경계) ~ 2점(tolMin)

상한 grace zone (tolMax ~ tolMax+0.05):
  graceRatio = 1 - (파고 - tolMax) / 0.05
  waveFit = 1 + graceRatio  →  2점(tolMax) ~ 1점(경계)
```

#### 코드 변경 (diff)

```diff
  if (waveHeight < optMin) {
-   if (waveHeight < tolMin) return 0;
+   if (waveHeight < tolMin) {
+     // grace zone 하한: tolMin-0.05 ~ tolMin
+     if (waveHeight >= tolMin - GRACE_MARGIN) {
+       const graceRatio = (waveHeight - (tolMin - GRACE_MARGIN)) / GRACE_MARGIN;
+       return clamp010(1 + graceRatio);  // 1~2점
+     }
+     return 0;
+   }
    // ... 기존 tolMin~optMin 선형 감점 로직 유지

- if (waveHeight > tolMax) return 0;
+ if (waveHeight > tolMax) {
+   // grace zone 상한: tolMax ~ tolMax+0.05
+   if (waveHeight <= tolMax + GRACE_MARGIN) {
+     const graceRatio = 1 - (waveHeight - tolMax) / GRACE_MARGIN;
+     return clamp010(1 + graceRatio);  // 2~1점
+   }
+   return 0;
+ }
```

---

### 4-2. 약풍 풍향 보정 (FN-2): `applyLightWindDirCorrection()`

**위치**: STEP 2 직후, STEP 3 전 (새 함수)

#### 보정 규칙

```
effectiveWind = max(windSpeed, windGusts × 0.7)

┌─────────────────────┬─────────────────────────────────────────┐
│ effectiveWind       │ 보정                                     │
├─────────────────────┼─────────────────────────────────────────┤
│ < 5 (글래시)        │ windDirFit = max(기존값, 7)              │
│ 5 ~ 8 (매우 약함)   │ windDirFit = max(기존값, (기존값+7)/2)   │
│ ≥ 8 (바람 있음)     │ 보정 없음                                │
└─────────────────────┴─────────────────────────────────────────┘
```

#### 왜 max() 사용?

```
max(기존값, 7)의 의미:
  - 이미 오프쇼어(windDirFit=10)면 → max(10, 7) = 10 (변동 없음)
  - 온쇼어(windDirFit=1)면 → max(1, 7) = 7 (보정)
  → "이미 좋은 점수를 깎지 않음" 보장
```

#### 품질 게이트와의 상호작용

```
시나리오: 글래시(2km/h) + 온쇼어 + 짧은 주기(5초)

STEP 2:   windDirFit = 1 (온쇼어), periodFit = 1 (짧은 주기)
STEP 2.5: windDirFit = max(1, 7) = 7 (글래시 보정)
STEP 3:   가중합에 windDirFit=7 반영 → 점수 개선
STEP 3.5: 품질 게이트 조건 "windDirFit ≤ 2 AND periodFit ≤ 2"
          → windDirFit=7 > 2 → 조건 미충족 → 게이트 미발동

이것이 올바른 이유:
  글래시에서 온쇼어는 실제로 무의미
  → 품질 게이트가 "온쇼어 + 짧은 주기"로 걸리면 과잉 감점
  → 보정이 게이트를 회피하는 것이 정확한 동작
```

---

### 4-3. 하드블록 grace zone (FN-1): `applyHardBlockGraceZone()`

**위치**: STEP 3.5(거짓양성 보정) 이후, STEP 4(메시지) 전

#### 적용 조건 (4가지 ALL 충족)

```
조건 1: levelFit.BEGINNER === 'BLOCKED'
  → 파고 하드블록에 의해 차단된 상태여야 함

조건 2: waveHeight > 1.2 AND waveHeight ≤ 1.4
  → grace zone 범위 (1.2m 초과 ~ 1.4m 이하)
  → 1.41m부터는 절대 완화 안 함

조건 3: breakType === 'beach_break'
  → reef_break, point_break에서는 절대 완화 안 함
  → 모래바닥에서만 경미한 초과를 허용

조건 4: 나머지 4개 fit(period, windSpeed, swell, windDir) 평균 ≥ 7.0
  → 나머지 조건이 "매우 좋음" 수준이어야 함
  → 바람 세거나 주기 짧으면 완화 거부
```

#### 적용 결과

```
BLOCKED → WARNING (PASS가 아님!)

기존 safetyReason:
  "파고 X.Xm - 초보자에게 위험"

교체 후:
  "파고 X.Xm - 초보에겐 여전히 높은 파고, 경험자 동행 필수"
```

#### 왜 PASS가 아닌 WARNING?

```
PASS로 완화하면:
  사용자: "파도 1.25m인데 안전하대!" → 무방비 입수
  실제: 초보자에게 1.25m는 여전히 높은 편

WARNING으로 완화하면:
  사용자: "주의가 필요하대, 조심해서 들어가자"
  실제: 인지하고 있으면 서핑 가능한 수준
```

#### 문구 톤 설계 (초보 안전 관점)

```
초기 문구 (v1.4.2 초안):
  "파고 1.3m - 약간 높지만 다른 조건이 좋아 주의하며 서핑 가능"
                                                ^^^^^^^^
  문제: "가능"이라는 단어 → 초보가 "가도 된다"로 해석

최종 문구 (v1.4.2 확정):
  "파고 1.3m - 초보에겐 여전히 높은 파고, 경험자 동행 필수"
               ^^^^^^^^                    ^^^^^^^^^^^^
  개선: "여전히 높다"는 위험 인지 + "경험자 동행 필수"로 행동 유도

  → "가능"이라는 표현을 제거하고, "동행 필수"로 안전 책임을 명시
```

---

## 5. 결과 검증 (실제 수치)

### 5-1. FN-4: 파고 0.28m — 수치 추적

```
입력: 양양 죽도, beach_break, BEGINNER
  파고 0.28m, 주기 10초, 풍속 5km/h, 오프쇼어
  스웰 NE 0.3m/10초, 수온 22°C

──────────────────────────────────────────────────────
STEP 1: 하드블록
  모든 항목 PASS

──────────────────────────────────────────────────────
STEP 2: 5Fit 점수
  waveFit:
    tolMin = 0.30 (beach_break BEGINNER 템플릿)
    파고 0.28 < tolMin(0.30)
    grace zone: tolMin-0.05=0.25 ~ tolMin=0.30
    0.28 ≥ 0.25 → grace zone 내!
    graceRatio = (0.28 - 0.25) / 0.05 = 0.6
    waveFit = 1 + 0.6 = 1.6  ← 기존: 0

  periodFit    = 8   (10초: 좋은 ground swell)
  windSpeedFit = 8   (effectiveWind=5.6)
  swellFit     = 7.2 (NE 방향 매칭 + 스웰 0.3m)
  windDirFit   = 10  (오프쇼어)

──────────────────────────────────────────────────────
STEP 3: 가중 합산
  rawScore = 1.6×0.25 + 8×0.10 + 8×0.20 + 7.2×0.25 + 10×0.20
           = 0.40     + 0.80   + 1.60   + 1.80     + 2.00
           = 6.60

  waveFit = 1.6 < 3 → waveMultiplier = 0.2 + 0.8×(1.6/3) = 0.627
  surfRating = clamp010(6.60 × 0.627) = 4.1

──────────────────────────────────────────────────────
STEP 3.5: 거짓양성 보정 → 미적용 (안전한 조건)
STEP 3.7: 거짓음성 보정 → 해당 없음 (BLOCKED 아님)

──────────────────────────────────────────────────────
STEP 4: 추천 메시지
  surfRating = 4.1 (3~5 범위) → "컨디션이 아쉬워요"
  levelFit = PASS → 주의 없음
```

#### v1.4.1 → v1.4.2 비교

| 항목 | v1.4.1 (보정 전) | v1.4.2 (보정 후) |
|------|:-:|:-:|
| waveFit | **0** | **1.6** |
| waveMultiplier | 0.20 | **0.627** |
| surfRating | **~1.2** | **4.1** |
| 추천 메시지 | "오늘은 쉬는 게 좋겠어요" | **"컨디션이 아쉬워요"** |
| 사용자 행동 | "파도 없대, 포기" | **"파도 약하지만 갈 만은 함"** |

---

### 5-2. FN-2: 글래시 + 온쇼어 — 수치 추적

```
입력: 양양 죽도, beach_break, BEGINNER
  파고 0.7m, 주기 10초, 풍속 3km/h, gust 4km/h
  windDirection=90 (FROM 동쪽 → 온쇼어)
  스웰 NE 0.6m/10초, 수온 22°C

──────────────────────────────────────────────────────
STEP 2: 5Fit 점수
  waveFit     = 10  (파고 0.7m: optimal 0.5~1.0 범위 안)
  periodFit   = 8   (10초)
  windSpeedFit = 10 (effectiveWind = max(3, 2.8) = 3 < 5 → 글래시)
  swellFit    = 7.8
  windDirFit  = 1   (FROM 90° → TO 270°, 동해안 90°와 180° 차이 → 온쇼어)

──────────────────────────────────────────────────────
★ STEP 2.5: 약풍 풍향 보정
  effectiveWind = 3 < 5 (글래시)
  windDirFit = max(1, 7) = 7  ← 기존: 1

──────────────────────────────────────────────────────
STEP 3: 가중 합산
  rawScore = 10×0.25 + 8×0.10 + 10×0.20 + 7.8×0.25 + 7×0.20
           = 2.50    + 0.80   + 2.00    + 1.95     + 1.40
           = 8.65

  waveFit = 10 ≥ 3 → waveMultiplier = 1.0
  surfRating = 8.7

──────────────────────────────────────────────────────
STEP 3.5: 거짓양성 보정
  compound: riskIndex = 0 → 미적용
  quality: windDirFit = 7 > 2 → 게이트 미발동 ← 보정 효과!

──────────────────────────────────────────────────────
STEP 4: "서핑하기 좋은 날이에요!" + PASS
```

#### v1.4.1 → v1.4.2 비교

| 항목 | v1.4.1 (보정 전) | v1.4.2 (보정 후) |
|------|:-:|:-:|
| windDirFit | **1** | **7** |
| surfRating | **~5.5** | **8.7** |
| 추천 메시지 | "무난한 컨디션이에요" | **"서핑하기 좋은 날이에요!"** |
| 사용자 행동 | "5점이면 별로네" | **"8.7점! 완전 좋다"** |

---

### 5-3. FN-1: 파고 1.25m + 완벽 — 수치 추적

```
입력: 양양 죽도, beach_break, BEGINNER
  파고 1.25m, 주기 12초, 풍속 3km/h, gust 5km/h
  windDirection=270 (오프쇼어)
  스웰 NE 0.8m/12초, 수온 22°C

──────────────────────────────────────────────────────
STEP 1: 하드블록
  파고 1.25m > 1.2m → BEGINNER BLOCKED
  safetyReasons = ["파고 1.3m - 초보자에게 위험"]

──────────────────────────────────────────────────────
STEP 2 + 2.5: 5Fit 점수
  waveFit     = 1   (파고 1.25m: tolMax=1.2 → 상한 grace zone 1.2~1.25 → 2~1점)
  periodFit   = 9   (12초)
  windSpeedFit = 10 (글래시)
  swellFit    = 8.3
  windDirFit  = 10  (오프쇼어, 글래시 보정 불필요 - 이미 10점)

──────────────────────────────────────────────────────
STEP 3: surfRating = 3.4 (waveFit=1 → waveMultiplier 낮음)

──────────────────────────────────────────────────────
STEP 3.5: 거짓양성 보정 → 미적용

──────────────────────────────────────────────────────
★ STEP 3.7: 거짓음성 보정 - 하드블록 grace zone

  조건 1: levelFit.BEGINNER === 'BLOCKED' → ✅
  조건 2: 1.25m > 1.2 AND 1.25m ≤ 1.4 → ✅ (grace zone 내)
  조건 3: breakType === 'beach_break' → ✅
  조건 4: 나머지 fit 평균 = (9 + 10 + 8.3 + 10) / 4 = 9.3 ≥ 7.0 → ✅

  ALL 충족!
  BEGINNER: BLOCKED → WARNING
  safetyReason: "파고 1.3m - 초보에겐 여전히 높은 파고, 경험자 동행 필수"

──────────────────────────────────────────────────────
STEP 4: "컨디션이 아쉬워요 단, 주의가 필요합니다."
```

#### v1.4.1 → v1.4.2 비교

| 항목 | v1.4.1 (보정 전) | v1.4.2 (보정 후) |
|------|:-:|:-:|
| BEGINNER levelFit | **BLOCKED** | **WARNING** |
| safetyReason | "초보자에게 위험" | **"주의하며 서핑 가능"** |
| 추천 메시지 | "파고 1.3m - 초보자에게 위험" | **"컨디션이 아쉬워요 단, 주의가 필요합니다."** |
| 사용자 행동 | "차단됐네, 다른 곳 찾자" | **"주의래, 조심해서 해보자"** |

---

### 5-4. 안전 검증: 보정이 개입하면 안 되는 시나리오

#### reef + 파고 1.25m → BLOCKED 유지

```
입력: 제주 중문, reef_break, INTERMEDIATE

STEP 1: 하드블록 → BEGINNER BLOCKED (reef + 파고 초과)
STEP 3.7: grace zone 조건 3 "breakType === 'beach_break'" → ❌ reef
  → 미적용 → BLOCKED 유지

결과: BEGINNER BLOCKED, "리프/포인트 브레이크 - 초보자 서핑 금지" ✅
```

#### 파고 1.41m + beach_break + 완벽 → BLOCKED 유지

```
입력: 양양 죽도, beach_break, 파고 1.41m

STEP 1: 하드블록 → BEGINNER BLOCKED (파고 > 1.2m)
STEP 3.7: grace zone 조건 2 "waveHeight ≤ 1.4" → ❌ 1.41m > 1.4
  → 미적용 → BLOCKED 유지

결과: BEGINNER BLOCKED, "파고 1.4m - 초보자에게 위험" ✅
```

#### 파고 1.25m + 나쁜 조건 → BLOCKED 유지

```
입력: 양양 죽도, 파고 1.25m, 풍속 20km/h, 온쇼어, 주기 5초

STEP 3.7: grace zone 조건 4 "나머지 fit 평균 ≥ 7.0"
  periodFit=1 + windSpeedFit=2 + swellFit=0.5 + windDirFit=1 → 평균 1.1 < 7.0
  → ❌ 미적용 → BLOCKED 유지

결과: BEGINNER BLOCKED, "파고 1.3m - 초보자에게 위험" ✅
```

#### 위험 시나리오 5건 → 전부 BLOCKED/WARNING (PASS 0건)

```
C-8 [파고 2.0m]:           BEG=BLOCKED 점수=1.4  ✅
C-8 [파고 1.5m + 강풍]:    BEG=BLOCKED 점수=0.6  ✅
C-8 [수온 9°C]:            BEG=BLOCKED 점수=8.9  ✅
C-8 [gust 50km/h]:         BEG=BLOCKED 점수=5.1  ✅
C-8 [파고 1.41m + 완벽]:   BEG=BLOCKED 점수=1.4  ✅

→ 위험 시나리오에서 BEGINNER PASS 된 건 0건
```

---

### 5-5. 실제 스팟 종합 시나리오 (양양 죽도)

```
========== 양양 죽도 v1.4.2 종합 ==========

[완벽한 날]
  점수: 9.5 | BEG: PASS
  "완벽한 서핑 컨디션이에요!"         ← 보정 개입 없음 ✅

[파고 살짝 부족(0.28m)]
  점수: 4.1 | BEG: PASS
  "컨디션이 아쉬워요"                  ← FN-4 보정 (기존: ~1.2점)

[글래시+온쇼어]
  점수: 8.7 | BEG: PASS
  "서핑하기 좋은 날이에요!"            ← FN-2 보정 (기존: ~5.5점)

[파고 1.25m+완벽]
  점수: 3.4 | BEG: WARNING
  "컨디션이 아쉬워요 단, 주의 필요"    ← FN-1 보정 (기존: BLOCKED)

[파고 1.25m+강풍]
  점수: 0.6 | BEG: BLOCKED
  "파고 1.3m - 초보자에게 위험"        ← 보정 거부 (나쁜 조건) ✅

[완전 플랫(0.1m)]
  점수: 1.1 | BEG: PASS
  "오늘은 쉬는 게 좋겠어요"            ← grace 밖, 보정 없음 ✅
```

---

## 6. 테스트 결과 종합

### 전체 테스트 (58개 + 검증 21개 전부 통과)

```
PASS surf-rating.util.spec.ts
  풍향 FROM → TO 변환                    4 passed
  gust(돌풍) 반영                        3 passed
  waveFit 경계값                         3 passed
  하드블록 차단                           5 passed
  safetyReasons 다중 사유 축적            3 passed
  부분 override                          3 passed
  getSimpleCondition                     3 passed
  periodFit 구간                         3 passed
  거짓양성 시나리오                       8 passed
  safetyReasons 우선순위 정렬             4 passed
  v1.4.1 복합 위험 감점 (Compound Risk)   3 passed
  v1.4.1 품질 게이트 (Quality Gate)       3 passed
  v1.4.2 FN-4: waveFit grace margin      5 passed  ← 신규
  v1.4.2 FN-2: 약풍 시 windDirFit 보정    4 passed  ← 신규
  v1.4.2 FN-1: 하드블록 grace zone        4 passed  ← 신규

Tests: 58 passed, 0 failed

PASS surf-rating-v142-verify.spec.ts
  A. v1.4.1 거짓양성 보정 회귀 검증       5 passed  ← 회귀 없음
  B. 거짓음성 해결 검증 (실제 시나리오)    7 passed  ← 3건 모두 해결
  C. 과잉 보정 안전 검증                  8 passed  ← 안전 침해 0건
  D. 실제 스팟 종합 비교                  1 passed

Tests: 21 passed, 0 failed
```

### 검증 항목별 결과

| 검증 항목 | 기대 | 실제 | 결과 |
|-----------|------|------|:----:|
| FN-4 해결: 파고 0.28m | waveFit > 0, surfRating > 2 | waveFit=1.6, 4.1점 | **PASS** |
| FN-2 해결: 글래시+온쇼어 | windDirFit ≥ 7, surfRating ≥ 7 | windDirFit=7, 8.7점 | **PASS** |
| FN-1 해결: 파고 1.25m+완벽 | WARNING (BLOCKED 아님) | WARNING | **PASS** |
| 거짓양성 #1 회귀 없음 | WARNING + ≤ 4.0 | WARNING + 3.9점 | **PASS** |
| 거짓양성 #2 회귀 없음 | ≤ 4.0 | 3.3점 | **PASS** |
| reef 완화 안 됨 | BLOCKED | BLOCKED | **PASS** |
| 파고 1.41m 완화 안 됨 | BLOCKED | BLOCKED | **PASS** |
| 보통 바람 보정 안 됨 | windDirFit ≤ 1 | windDirFit=1 | **PASS** |
| 위험 시나리오 5건 | 전부 !PASS | 전부 BLOCKED | **PASS** |
| 기존 45개 테스트 | 전부 통과 | 전부 통과 | **PASS** |

---

## 7. 구현 파일 정리

```
수정된 파일:
  surf-wave-backend/src/modules/forecasts/utils/surf-rating.util.ts
    - calcWaveFit(): grace margin 추가 (하한/상한 양쪽)
    - applyLightWindDirCorrection(): 신규 함수 (STEP 2.5)
    - applyHardBlockGraceZone(): 신규 함수 (STEP 3.7)
    - calculateSurfRating(): STEP 2.5 + STEP 3.7 삽입
    - 파일 버전: v1.4.1 → v1.4.2

  surf-wave-backend/src/modules/forecasts/utils/surf-rating.util.spec.ts
    - 섹션 12: v1.4.2 FN-4 테스트 5건 신규
    - 섹션 12: v1.4.2 FN-2 테스트 4건 신규
    - 섹션 12: v1.4.2 FN-1 테스트 4건 신규
    - 총 테스트: 45개 → 58개

  surf-wave-backend/src/modules/forecasts/utils/surf-rating-v142-verify.spec.ts
    - 실제 스팟 시나리오 검증 21건 (신규 파일)
```

---

## 8. 주의사항 및 향후 개선

### 이 방식의 장점
- **안전 우선**: 모든 보정에 엄격한 안전장치 (reef 제외, 상한 제한, WARNING만)
- **기존 엔진 최소 수정**: calcWaveFit() 내부 grace만 추가, 나머지는 후처리
- **v1.4.1 보정과 독립**: 거짓양성 보정이 깨지지 않음 (회귀 검증 완료)
- **테스트 가능**: 58개 단위 테스트 + 21개 시나리오 검증으로 동작 고정

### 이 방식의 한계
- grace margin 5cm, grace zone 1.2~1.4m은 **경험적 값** → 실제 운영 데이터로 튜닝 필요
- FN-1 grace zone의 "fit 평균 ≥ 7.0"이 **너무 엄격할 수 있음** → 피드백 기반 조정
- 약풍 보정의 effectiveWind 임계값(5, 8)도 **해역별로 다를 수 있음**

### 향후 개선 방향
- 사용자 피드백("오늘 실제로 서핑 가능했나요?") 데이터 축적 → 임계값 자동 튜닝
- 해역별 바람 특성 반영 (발리 vs 동해안 → 약풍 기준 다를 수 있음)
- FN-1 grace zone을 INTERMEDIATE에도 확장 검토 (파고 2.5~2.8m + 좋은 조건)
- 데이터 충분히 쌓이면 → 보정 필터를 ML 모델로 대체 검토

### v1.4.1 → v1.4.2 보정 계보

```
v1.4:   기본 엔진 (하드블록 + 5Fit + 가중합)
v1.4.1: + 거짓양성 보정 (STEP 3.5 - compound risk + quality gate)
v1.4.2: + 거짓음성 보정 (STEP 2.5 약풍 + calcWaveFit grace + STEP 3.7 grace zone)
```
