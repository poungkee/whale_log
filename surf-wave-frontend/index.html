<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Surf Wave - ì„œí•‘ ì˜ˆë³´</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --card-hover: #334155;
      --border: #334155;
      --text: #e2e8f0;
      --text-dim: #94a3b8;
      --accent: #38bdf8;
      --green: #22c55e;
      --yellow: #eab308;
      --orange: #f97316;
      --red: #ef4444;
      --blue: #3b82f6;
      --nav-height: 64px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding-bottom: var(--nav-height);
      -webkit-tap-highlight-color: transparent;
    }

    /* ============ Screens ============ */
    .screen {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    .screen.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ============ Onboarding ============ */
    #onboarding {
      min-height: 100vh;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      text-align: center;
    }
    #onboarding.active {
      display: flex;
    }

    .onboarding-title {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .onboarding-subtitle {
      font-size: 15px;
      color: var(--text-dim);
      margin-bottom: 36px;
      line-height: 1.5;
    }

    .level-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      width: 100%;
      max-width: 400px;
    }

    .level-card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 20px 14px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .level-card:hover { border-color: var(--accent); transform: translateY(-2px); }
    .level-card:active { transform: scale(0.97); }

    .level-card .icon { font-size: 36px; margin-bottom: 8px; }
    .level-card .name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .level-card .desc { font-size: 12px; color: var(--text-dim); line-height: 1.4; }

    .level-card[data-level="BEGINNER"] { border-color: #065f46; }
    .level-card[data-level="BEGINNER"]:hover { border-color: var(--green); background: rgba(34,197,94,0.1); }
    .level-card[data-level="INTERMEDIATE"] { border-color: #854d0e; }
    .level-card[data-level="INTERMEDIATE"]:hover { border-color: var(--yellow); background: rgba(234,179,8,0.1); }
    .level-card[data-level="ADVANCED"] { border-color: #9a3412; }
    .level-card[data-level="ADVANCED"]:hover { border-color: var(--orange); background: rgba(249,115,22,0.1); }
    .level-card[data-level="EXPERT"] { border-color: #991b1b; }
    .level-card[data-level="EXPERT"]:hover { border-color: var(--red); background: rgba(239,68,68,0.1); }

    /* ============ Header ============ */
    .header {
      background: linear-gradient(135deg, #0c4a6e 0%, #164e63 100%);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green); display: inline-block;
      animation: pulse 2s infinite;
    }
    .status-dot.error { background: var(--red); animation: none; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

    .refresh-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }
    .refresh-btn:hover { background: rgba(255,255,255,0.2); }

    /* ============ Level Badge (header) ============ */
    .level-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .level-badge.BEGINNER { background: #065f46; color: #6ee7b7; }
    .level-badge.INTERMEDIATE { background: #854d0e; color: #fde047; }
    .level-badge.ADVANCED { background: #9a3412; color: #fdba74; }
    .level-badge.EXPERT { background: #991b1b; color: #fca5a5; }

    /* ============ Summary Bar ============ */
    .summary-bar {
      display: flex;
      gap: 12px;
      padding: 14px 20px;
      background: rgba(56, 189, 248, 0.05);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .summary-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-dim);
    }
    .summary-item strong { color: var(--text); font-size: 16px; }

    /* ============ Filters ============ */
    .controls {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      align-items: center;
      flex-wrap: wrap;
      overflow-x: auto;
    }
    .filter-btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 6px 14px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .filter-btn:hover { border-color: var(--accent); color: var(--text); }
    .filter-btn.active { background: var(--accent); color: #0f172a; border-color: var(--accent); font-weight: 600; }

    /* ============ Grid ============ */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      padding: 0 20px 20px;
    }

    /* ============ Card (Common) ============ */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      transition: transform 0.2s, border-color 0.2s;
    }
    .card:hover { transform: translateY(-2px); border-color: var(--accent); }

    .card-header {
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 1px solid var(--border);
    }
    .spot-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .spot-meta { display: flex; gap: 8px; font-size: 12px; color: var(--text-dim); align-items: center; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }
    .badge-beginner { background: #065f46; color: #6ee7b7; }
    .badge-intermediate { background: #854d0e; color: #fde047; }
    .badge-advanced { background: #9a3412; color: #fdba74; }
    .badge-expert { background: #991b1b; color: #fca5a5; }

    /* Rating circle */
    .rating-circle {
      width: 48px; height: 48px; border-radius: 50%;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-weight: 700; font-size: 18px; flex-shrink: 0;
    }
    .rating-circle .label { font-size: 8px; font-weight: 400; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 1px; }
    .rating-1 { background: rgba(239,68,68,0.2); color: var(--red); border: 2px solid var(--red); }
    .rating-2 { background: rgba(249,115,22,0.2); color: var(--orange); border: 2px solid var(--orange); }
    .rating-3 { background: rgba(234,179,8,0.2); color: var(--yellow); border: 2px solid var(--yellow); }
    .rating-4 { background: rgba(34,197,94,0.2); color: var(--green); border: 2px solid var(--green); }
    .rating-5 { background: rgba(56,189,248,0.2); color: var(--accent); border: 2px solid var(--accent); }

    /* ============ BEGINNER Card ============ */
    .beginner-card .big-status {
      text-align: center;
      padding: 24px 16px;
    }
    .beginner-card .big-emoji { font-size: 56px; margin-bottom: 10px; }
    .beginner-card .big-message {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .beginner-card .simple-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 12px;
    }
    .beginner-card .simple-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .beginner-card .simple-item .item-label {
      font-size: 12px;
      color: var(--text-dim);
    }
    .beginner-card .simple-item .item-value {
      font-size: 16px;
      font-weight: 600;
      padding: 4px 14px;
      border-radius: 20px;
      background: rgba(255,255,255,0.05);
    }

    /* ============ INTERMEDIATE Card ============ */
    .inter-card .inter-body {
      padding: 16px;
    }
    .inter-card .inter-message {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .inter-card .inter-stats {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    .inter-card .inter-stat {
      text-align: center;
      background: rgba(255,255,255,0.03);
      padding: 10px;
      border-radius: 10px;
    }
    .inter-card .inter-stat .stat-value {
      font-size: 22px;
      font-weight: 700;
    }
    .inter-card .inter-stat .stat-unit {
      font-size: 11px;
      color: var(--text-dim);
    }
    .inter-card .inter-stat .stat-label {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    /* ============ ADVANCED / EXPERT Card ============ */
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1px;
      background: var(--border);
    }
    .data-cell {
      background: var(--card);
      padding: 10px;
      text-align: center;
    }
    .data-cell .value { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
    .data-cell .unit { font-size: 11px; color: var(--text-dim); }
    .data-cell .label { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

    /* Card Footer */
    .card-footer {
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-dim);
      border-top: 1px solid var(--border);
    }
    .card-footer .recommendation {
      font-style: italic;
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .direction-arrow { display: inline-block; transition: transform 0.3s; font-size: 14px; }

    /* ============ No Data / Loading / Error ============ */
    .no-data { padding: 24px; text-align: center; color: var(--text-dim); font-size: 14px; }
    .loading { display: flex; justify-content: center; align-items: center; padding: 60px; font-size: 15px; color: var(--text-dim); }
    .spinner { width: 28px; height: 28px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin-right: 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-box { background: rgba(239,68,68,0.1); border: 1px solid var(--red); border-radius: 8px; padding: 20px; margin: 20px; text-align: center; color: var(--red); }

    /* ============ Bottom Navigation ============ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      background: #1a2332;
      border-top: 1px solid var(--border);
      display: flex;
      z-index: 200;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 11px;
      transition: color 0.2s;
      border: none;
      background: none;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-item:hover, .nav-item.active { color: var(--accent); }
    .nav-item svg { width: 22px; height: 22px; }

    /* ============ Settings Screen ============ */
    #settings { padding: 20px; }
    .settings-title { font-size: 22px; font-weight: 700; margin-bottom: 24px; padding-top: 60px; }
    .settings-section { margin-bottom: 24px; }
    .settings-section-title { font-size: 14px; color: var(--text-dim); margin-bottom: 12px; font-weight: 600; }

    .settings-level-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .settings-level-card {
      background: var(--card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 14px 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .settings-level-card:hover { border-color: var(--accent); }
    .settings-level-card.selected { border-color: var(--accent); background: rgba(56,189,248,0.1); }
    .settings-level-card .icon { font-size: 28px; margin-bottom: 4px; }
    .settings-level-card .name { font-size: 14px; font-weight: 600; }

    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--card);
      padding: 14px 16px;
      border-radius: 12px;
      margin-bottom: 10px;
    }
    .toggle-row .toggle-label { font-size: 14px; }
    .toggle-switch {
      position: relative;
      width: 48px; height: 26px;
      background: var(--border);
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
    }
    .toggle-switch.on { background: var(--accent); }
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px; left: 3px;
      width: 20px; height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle-switch.on::after { transform: translateX(22px); }

    /* Responsive: larger screens */
    @media (min-width: 600px) {
      .grid { grid-template-columns: 1fr 1fr; max-width: 800px; margin: 0 auto; }
      .level-cards { max-width: 440px; }
    }
    @media (min-width: 960px) {
      .grid { grid-template-columns: 1fr 1fr 1fr; max-width: 1100px; }
    }
  </style>
</head>
<body>

<!-- ============ Onboarding Screen ============ -->
<div id="onboarding" class="screen">
  <div class="onboarding-title">ğŸ„ ì„œí•‘ ë ˆë²¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
  <div class="onboarding-subtitle">ë ˆë²¨ì— ë§ëŠ” ë§ì¶¤ ì˜ˆë³´ë¥¼ ë³´ì—¬ë“œë¦´ê²Œìš”</div>
  <div class="level-cards">
    <div class="level-card" data-level="BEGINNER" onclick="selectLevel('BEGINNER')">
      <div class="icon">ğŸŒŠ</div>
      <div class="name">ì´ˆê¸‰</div>
      <div class="desc">ì²˜ìŒ ì‹œì‘í•´ìš”<br>íŒŒë„ ì¡ê¸° ì—°ìŠµ ì¤‘</div>
    </div>
    <div class="level-card" data-level="INTERMEDIATE" onclick="selectLevel('INTERMEDIATE')">
      <div class="icon">ğŸ„</div>
      <div class="name">ì¤‘ê¸‰</div>
      <div class="desc">ê¸°ë³¸ê¸° ìˆì–´ìš”<br>í…Œì´í¬ì˜¤í”„ ê°€ëŠ¥</div>
    </div>
    <div class="level-card" data-level="ADVANCED" onclick="selectLevel('ADVANCED')">
      <div class="icon">ğŸ„â€â™‚ï¸</div>
      <div class="name">ìƒê¸‰</div>
      <div class="desc">ììœ ë¡­ê²Œ íƒ€ìš”<br>ë‹¤ì–‘í•œ ê¸°ìˆ  êµ¬ì‚¬</div>
    </div>
    <div class="level-card" data-level="EXPERT" onclick="selectLevel('EXPERT')">
      <div class="icon">ğŸ†</div>
      <div class="name">ì „ë¬¸ê°€</div>
      <div class="desc">í”„ë¡œ ìˆ˜ì¤€ì´ì—ìš”<br>ëŒ€íšŒ ì°¸ê°€ ë ˆë²¨</div>
    </div>
  </div>
</div>

<!-- ============ Dashboard Screen ============ -->
<div id="dashboard" class="screen">
  <div class="header">
    <h1>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M2 12c2-3 5-5 10-5s8 2 10 5"/>
        <path d="M2 16c2-3 5-5 10-5s8 2 10 5"/>
        <path d="M2 20c2-3 5-5 10-5s8 2 10 5"/>
      </svg>
      ì„œí•‘ ì˜ˆë³´
      <span id="headerLevelBadge" class="level-badge"></span>
    </h1>
    <div class="header-right">
      <span id="statusIndicator"><span class="status-dot"></span> ì‹¤ì‹œê°„</span>
      <span id="lastUpdated">--</span>
      <button class="refresh-btn" onclick="fetchData()">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </div>

  <div class="summary-bar" id="summaryBar">
    <div class="summary-item">
      <span>ìŠ¤íŒŸ</span>
      <strong id="totalSpots">--</strong>
    </div>
    <div class="summary-item">
      <span>ë°ì´í„°</span>
      <strong id="withData">--</strong>
    </div>
    <div class="summary-item">
      <span>í‰ê·  ì ìˆ˜</span>
      <strong id="avgRating">--</strong>
    </div>
    <div class="summary-item">
      <span>ë² ìŠ¤íŠ¸</span>
      <strong id="bestSpot" style="font-size:13px">--</strong>
    </div>
  </div>

  <div class="controls" id="controlsBar">
    <button class="filter-btn active" data-region="all" onclick="setFilter('all', this)">ì „ì²´</button>
  </div>

  <div id="content">
    <div class="loading"><div class="spinner"></div>ì˜ˆë³´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
</div>

<!-- ============ Settings Screen ============ -->
<div id="settings" class="screen">
  <div class="settings-title">âš™ï¸ ì„¤ì •</div>

  <div class="settings-section">
    <div class="settings-section-title">ì„œí•‘ ë ˆë²¨</div>
    <div class="settings-level-cards" id="settingsLevelCards">
      <div class="settings-level-card" data-level="BEGINNER" onclick="changeLevel('BEGINNER')">
        <div class="icon">ğŸŒŠ</div>
        <div class="name">ì´ˆê¸‰</div>
      </div>
      <div class="settings-level-card" data-level="INTERMEDIATE" onclick="changeLevel('INTERMEDIATE')">
        <div class="icon">ğŸ„</div>
        <div class="name">ì¤‘ê¸‰</div>
      </div>
      <div class="settings-level-card" data-level="ADVANCED" onclick="changeLevel('ADVANCED')">
        <div class="icon">ğŸ„â€â™‚ï¸</div>
        <div class="name">ìƒê¸‰</div>
      </div>
      <div class="settings-level-card" data-level="EXPERT" onclick="changeLevel('EXPERT')">
        <div class="icon">ğŸ†</div>
        <div class="name">ì „ë¬¸ê°€</div>
      </div>
    </div>
  </div>

  <div class="settings-section">
    <div class="settings-section-title">ê¸°ëŠ¥</div>
    <div class="toggle-row">
      <span class="toggle-label">ìë™ ìƒˆë¡œê³ ì¹¨ (60ì´ˆ)</span>
      <button class="toggle-switch" id="autoRefreshToggle" onclick="toggleAutoRefresh()"></button>
    </div>
  </div>
</div>

<!-- ============ Bottom Navigation ============ -->
<nav class="bottom-nav" id="bottomNav">
  <button class="nav-item active" data-screen="dashboard" onclick="navigateTo('dashboard')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
      <polyline points="9 22 9 12 15 12 15 22"/>
    </svg>
    <span>ëŒ€ì‹œë³´ë“œ</span>
  </button>
  <button class="nav-item" data-screen="settings" onclick="navigateTo('settings')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="3"/>
      <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
    </svg>
    <span>ì„¤ì •</span>
  </button>
</nav>

<script>
const API_BASE = 'http://localhost:3000/api/v1';
let allData = [];
let currentFilter = 'all';
let refreshInterval;
let autoRefreshEnabled = true;

const LEVEL_LABELS = {
  BEGINNER: 'ì´ˆê¸‰',
  INTERMEDIATE: 'ì¤‘ê¸‰',
  ADVANCED: 'ìƒê¸‰',
  EXPERT: 'ì „ë¬¸ê°€',
};

const DIFFICULTY_KO = {
  BEGINNER: 'ì´ˆê¸‰',
  INTERMEDIATE: 'ì¤‘ê¸‰',
  ADVANCED: 'ìƒê¸‰',
  EXPERT: 'ì „ë¬¸ê°€',
};

// ============ Init ============
function init() {
  const savedLevel = localStorage.getItem('surfLevel');
  const savedAutoRefresh = localStorage.getItem('autoRefresh');

  if (savedAutoRefresh !== null) {
    autoRefreshEnabled = savedAutoRefresh !== 'false';
  }
  updateAutoRefreshUI();

  if (!savedLevel) {
    showScreen('onboarding');
    document.getElementById('bottomNav').style.display = 'none';
  } else {
    document.getElementById('bottomNav').style.display = 'flex';
    showScreen('dashboard');
    updateHeaderBadge(savedLevel);
    updateSettingsLevel(savedLevel);
    fetchData();
    if (autoRefreshEnabled) startAutoRefresh();
  }
}

// ============ Navigation ============
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screen = document.getElementById(name);
  if (screen) screen.classList.add('active');
}

function navigateTo(screen) {
  showScreen(screen);
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const btn = document.querySelector(`.nav-item[data-screen="${screen}"]`);
  if (btn) btn.classList.add('active');
}

// ============ Onboarding ============
function selectLevel(level) {
  localStorage.setItem('surfLevel', level);
  document.getElementById('bottomNav').style.display = 'flex';
  showScreen('dashboard');
  updateHeaderBadge(level);
  updateSettingsLevel(level);
  fetchData();
  if (autoRefreshEnabled) startAutoRefresh();
}

// ============ Settings ============
function changeLevel(level) {
  localStorage.setItem('surfLevel', level);
  updateHeaderBadge(level);
  updateSettingsLevel(level);
  fetchData();
}

function updateHeaderBadge(level) {
  const badge = document.getElementById('headerLevelBadge');
  badge.textContent = LEVEL_LABELS[level] || level;
  badge.className = 'level-badge ' + level;
}

function updateSettingsLevel(level) {
  document.querySelectorAll('.settings-level-card').forEach(c => {
    c.classList.toggle('selected', c.dataset.level === level);
  });
}

function toggleAutoRefresh() {
  autoRefreshEnabled = !autoRefreshEnabled;
  localStorage.setItem('autoRefresh', autoRefreshEnabled);
  updateAutoRefreshUI();
  if (autoRefreshEnabled) {
    startAutoRefresh();
  } else {
    stopAutoRefresh();
  }
}

function updateAutoRefreshUI() {
  const toggle = document.getElementById('autoRefreshToggle');
  if (toggle) {
    toggle.classList.toggle('on', autoRefreshEnabled);
  }
}

// ============ Data Fetch ============
async function fetchData() {
  const level = localStorage.getItem('surfLevel') || '';
  const url = level
    ? `${API_BASE}/dashboard/forecasts?level=${level}`
    : `${API_BASE}/dashboard/forecasts`;

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    allData = data.spots || [];

    updateStatus(true);
    updateSummary(data);
    buildFilters(allData);
    renderCards(filterData(allData));
  } catch (err) {
    updateStatus(false);
    document.getElementById('content').innerHTML =
      `<div class="error-box">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${err.message}<br>ë°±ì—”ë“œ ì„œë²„(í¬íŠ¸ 3000)ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>`;
  }
}

function updateStatus(ok) {
  const el = document.getElementById('statusIndicator');
  if (ok) {
    el.innerHTML = '<span class="status-dot"></span> ì‹¤ì‹œê°„';
  } else {
    el.innerHTML = '<span class="status-dot error"></span> ì˜¤ë¥˜';
  }
  document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('ko-KR');
}

function updateSummary(data) {
  const spots = data.spots || [];
  const withData = spots.filter(s => s.forecast);
  const ratings = withData.map(s => s.surfRating);
  const avg = ratings.length ? (ratings.reduce((a, b) => a + b, 0) / ratings.length) : 0;
  const best = [...withData].sort((a, b) => b.surfRating - a.surfRating)[0];

  document.getElementById('totalSpots').textContent = data.totalSpots;
  document.getElementById('withData').textContent = withData.length;
  document.getElementById('avgRating').textContent = avg.toFixed(1);
  document.getElementById('bestSpot').textContent = best ? best.spot.name : '--';
}

function buildFilters(spots) {
  const regions = [...new Set(spots.map(s => s.spot.region).filter(Boolean))].sort();
  const controls = document.getElementById('controlsBar');
  const existing = controls.querySelectorAll('.filter-btn:not([data-region="all"])');
  existing.forEach(el => el.remove());

  regions.forEach(region => {
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (currentFilter === region ? ' active' : '');
    btn.dataset.region = region;
    btn.textContent = region;
    btn.onclick = () => setFilter(region, btn);
    controls.appendChild(btn);
  });

  const allBtn = controls.querySelector('[data-region="all"]');
  allBtn.className = 'filter-btn' + (currentFilter === 'all' ? ' active' : '');
}

function setFilter(region, btn) {
  currentFilter = region;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderCards(filterData(allData));
}

function filterData(spots) {
  if (currentFilter === 'all') return spots;
  return spots.filter(s => s.spot.region === currentFilter);
}

// ============ Rendering ============
function degToCompass(deg) {
  if (deg == null) return '--';
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return dirs[Math.round(deg / 22.5) % 16];
}

function getOverallEmoji(overall) {
  if (overall === 'ì¢‹ìŒ') return 'ğŸ„';
  if (overall === 'ì£¼ì˜') return 'âš ï¸';
  return 'ğŸŒ¤ï¸';
}

function getOverallColor(overall) {
  if (overall === 'ì¢‹ìŒ') return 'var(--green)';
  if (overall === 'ì£¼ì˜') return 'var(--red)';
  return 'var(--yellow)';
}

function renderCards(spots) {
  const level = localStorage.getItem('surfLevel') || 'EXPERT';

  if (!spots.length) {
    document.getElementById('content').innerHTML = '<div class="no-data">ì´ í•„í„°ì— í•´ë‹¹í•˜ëŠ” ìŠ¤íŒŸì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  spots.sort((a, b) => (b.surfRating || 0) - (a.surfRating || 0));

  let html;
  if (level === 'BEGINNER') {
    html = renderBeginnerCards(spots);
  } else if (level === 'INTERMEDIATE') {
    html = renderIntermediateCards(spots);
  } else {
    html = renderAdvancedCards(spots);
  }

  document.getElementById('content').innerHTML = html;
}

function renderBeginnerCards(spots) {
  return '<div class="grid">' + spots.map(item => {
    const { spot, forecast, surfRating, recommendationKo, simpleCondition } = item;
    const diffLabel = DIFFICULTY_KO[spot.difficulty] || spot.difficulty;

    if (!forecast || !simpleCondition) {
      return `
        <div class="card beginner-card">
          <div class="card-header">
            <div>
              <div class="spot-name">${esc(spot.name)}</div>
              <div class="spot-meta">
                <span>${esc(spot.region || '')}</span>
                <span class="badge badge-${(spot.difficulty||'').toLowerCase()}">${esc(diffLabel)}</span>
              </div>
            </div>
          </div>
          <div class="big-status">
            <div class="big-emoji">â“</div>
            <div class="big-message">ë°ì´í„°ê°€ ì•„ì§ ì—†ì–´ìš”</div>
          </div>
        </div>`;
    }

    const emoji = getOverallEmoji(simpleCondition.overall);
    const color = getOverallColor(simpleCondition.overall);

    return `
      <div class="card beginner-card">
        <div class="card-header">
          <div>
            <div class="spot-name">${esc(spot.name)}</div>
            <div class="spot-meta">
              <span>${esc(spot.region || '')}</span>
              <span class="badge badge-${(spot.difficulty||'').toLowerCase()}">${esc(diffLabel)}</span>
            </div>
          </div>
        </div>
        <div class="big-status">
          <div class="big-emoji">${emoji}</div>
          <div class="big-message" style="color:${color}">${esc(recommendationKo || '')}</div>
          <div class="simple-info">
            <div class="simple-item">
              <span class="item-label">íŒŒë„ ë†’ì´</span>
              <span class="item-value">${esc(simpleCondition.waveStatus)}</span>
            </div>
            <div class="simple-item">
              <span class="item-label">ë°”ëŒ</span>
              <span class="item-value">${esc(simpleCondition.windStatus)}</span>
            </div>
            <div class="simple-item">
              <span class="item-label">ì¢…í•©</span>
              <span class="item-value" style="color:${color}">${esc(simpleCondition.overall)}</span>
            </div>
          </div>
        </div>
      </div>`;
  }).join('') + '</div>';
}

function renderIntermediateCards(spots) {
  return '<div class="grid">' + spots.map(item => {
    const { spot, forecast, surfRating, recommendationKo, simpleCondition } = item;
    const rating = Math.round(surfRating) || 0;
    const diffLabel = DIFFICULTY_KO[spot.difficulty] || spot.difficulty;

    if (!forecast) {
      return `
        <div class="card inter-card">
          <div class="card-header">
            <div>
              <div class="spot-name">${esc(spot.name)}</div>
              <div class="spot-meta">
                <span>${esc(spot.region || '')}</span>
                <span class="badge badge-${(spot.difficulty||'').toLowerCase()}">${esc(diffLabel)}</span>
              </div>
            </div>
            <div class="rating-circle rating-1"><span>--</span></div>
          </div>
          <div class="no-data">ì˜ˆë³´ ë°ì´í„° ì—†ìŒ</div>
        </div>`;
    }

    const wh = Number(forecast.waveHeight).toFixed(1);
    const ws = forecast.windSpeed != null ? Number(forecast.windSpeed).toFixed(1) : '--';
    const wp = Number(forecast.wavePeriod).toFixed(0);
    const wd = Number(forecast.waveDirection).toFixed(0);
    const emoji = simpleCondition ? getOverallEmoji(simpleCondition.overall) : 'ğŸŒ¤ï¸';

    return `
      <div class="card inter-card">
        <div class="card-header">
          <div>
            <div class="spot-name">${esc(spot.name)}</div>
            <div class="spot-meta">
              <span>${esc(spot.region || '')}</span>
              <span class="badge badge-${(spot.difficulty||'').toLowerCase()}">${esc(diffLabel)}</span>
            </div>
          </div>
          <div class="rating-circle rating-${rating}">
            <span>${rating}</span>
            <span class="label">ì ìˆ˜</span>
          </div>
        </div>
        <div class="inter-body">
          <div class="inter-message">${emoji} ${esc(recommendationKo || '')}</div>
          <div class="inter-stats">
            <div class="inter-stat">
              <div class="stat-value">${wh}<span class="stat-unit">m</span></div>
              <div class="stat-label">íŒŒê³ </div>
            </div>
            <div class="inter-stat">
              <div class="stat-value">${ws}<span class="stat-unit">m/s</span></div>
              <div class="stat-label">í’ì†</div>
            </div>
            <div class="inter-stat">
              <div class="stat-value">${wp}<span class="stat-unit">s</span></div>
              <div class="stat-label">íŒŒì£¼ê¸°</div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <span>íŒŒë„ ë°©í–¥: ${degToCompass(wd)} (${wd}Â°)</span>
          <span>${new Date(forecast.forecastTime).toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' })}</span>
        </div>
      </div>`;
  }).join('') + '</div>';
}

function renderAdvancedCards(spots) {
  return '<div class="grid">' + spots.map(item => {
    const { spot, forecast, surfRating, recommendationKo } = item;
    const rating = Math.round(surfRating) || 0;
    const diffLabel = DIFFICULTY_KO[spot.difficulty] || spot.difficulty;

    if (!forecast) {
      return `
        <div class="card">
          <div class="card-header">
            <div>
              <div class="spot-name">${esc(spot.name)}</div>
              <div class="spot-meta">
                <span>${esc(spot.region || '')}</span>
                <span class="badge badge-${(spot.difficulty||'').toLowerCase()}">${esc(diffLabel)}</span>
              </div>
            </div>
            <div class="rating-circle rating-1"><span>--</span><span class="label">N/A</span></div>
          </div>
          <div class="no-data">ì˜ˆë³´ ë°ì´í„° ì—†ìŒ</div>
        </div>`;
    }

    const wh = Number(forecast.waveHeight).toFixed(1);
    const wp = Number(forecast.wavePeriod).toFixed(0);
    const wd = Number(forecast.waveDirection).toFixed(0);
    const ws = forecast.windSpeed != null ? Number(forecast.windSpeed).toFixed(1) : '--';
    const wg = forecast.windGusts != null ? Number(forecast.windGusts).toFixed(1) : '--';
    const wdir = forecast.windDirection != null ? Number(forecast.windDirection).toFixed(0) : null;
    const sh = forecast.swellHeight != null ? Number(forecast.swellHeight).toFixed(1) : '--';
    const sp = forecast.swellPeriod != null ? Number(forecast.swellPeriod).toFixed(0) : '--';
    const sd = forecast.swellDirection != null ? Number(forecast.swellDirection).toFixed(0) : null;

    const forecastTime = new Date(forecast.forecastTime).toLocaleString('ko-KR', {
      month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    });
    const fetchedAt = new Date(forecast.fetchedAt).toLocaleTimeString('ko-KR');

    return `
      <div class="card">
        <div class="card-header">
          <div>
            <div class="spot-name">${esc(spot.name)}</div>
            <div class="spot-meta">
              <span>${esc(spot.region || '')}</span>
              <span class="badge badge-${(spot.difficulty||'').toLowerCase()}">${esc(diffLabel)}</span>
              <span>${forecastTime}</span>
            </div>
          </div>
          <div class="rating-circle rating-${rating}">
            <span>${rating}</span>
            <span class="label">ì ìˆ˜</span>
          </div>
        </div>
        <div class="data-grid">
          <div class="data-cell">
            <div class="value">${wh}<span class="unit">m</span></div>
            <div class="label">íŒŒê³ </div>
          </div>
          <div class="data-cell">
            <div class="value">${wp}<span class="unit">s</span></div>
            <div class="label">íŒŒì£¼ê¸°</div>
          </div>
          <div class="data-cell">
            <div class="value"><span class="direction-arrow" style="transform:rotate(${wd}deg)">&#8593;</span> ${degToCompass(wd)}</div>
            <div class="label">íŒŒë„ ë°©í–¥</div>
          </div>
          <div class="data-cell">
            <div class="value">${ws}<span class="unit">m/s</span></div>
            <div class="label">í’ì†</div>
          </div>
          <div class="data-cell">
            <div class="value">${wg}<span class="unit">m/s</span></div>
            <div class="label">ëŒí’</div>
          </div>
          <div class="data-cell">
            <div class="value">${wdir != null ? `<span class="direction-arrow" style="transform:rotate(${wdir}deg)">&#8593;</span> ${degToCompass(wdir)}` : '--'}</div>
            <div class="label">ë°”ëŒ ë°©í–¥</div>
          </div>
          <div class="data-cell">
            <div class="value">${sh}<span class="unit">m</span></div>
            <div class="label">ìŠ¤ì›°</div>
          </div>
          <div class="data-cell">
            <div class="value">${sp}<span class="unit">s</span></div>
            <div class="label">ìŠ¤ì›° ì£¼ê¸°</div>
          </div>
          <div class="data-cell">
            <div class="value">${sd != null ? `<span class="direction-arrow" style="transform:rotate(${sd}deg)">&#8593;</span> ${degToCompass(sd)}` : '--'}</div>
            <div class="label">ìŠ¤ì›° ë°©í–¥</div>
          </div>
        </div>
        <div class="card-footer">
          <span class="recommendation" title="${esc(recommendationKo || '')}">${esc(recommendationKo || '')}</span>
          <span>ê°±ì‹  ${fetchedAt}</span>
        </div>
      </div>`;
  }).join('') + '</div>';
}

// ============ Utility ============
function esc(str) {
  if (!str) return '';
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function startAutoRefresh() {
  stopAutoRefresh();
  refreshInterval = setInterval(fetchData, 60000);
}

function stopAutoRefresh() {
  if (refreshInterval) {
    clearInterval(refreshInterval);
    refreshInterval = null;
  }
}

// ============ Boot ============
init();
</script>
</body>
</html>
